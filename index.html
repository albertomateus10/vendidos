<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Vendas — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<style>
    :root{
        --primary:#1e40af; --primary-2:#3b82f6; --border:#dbeafe; --ink:#0f172a; --soft:#f8fbff;
        --shadow:0 10px 24px rgba(30,64,175,.15); --danger:#dc2626; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{scroll-behavior:auto}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(135deg,#f0f6ff,#eaf3ff); margin:0; color:var(--ink)}
    .container{max-width:1600px; margin:24px auto; background:#fff; border:1px solid rgba(0,0,0,.04); border-radius:22px; box-shadow:var(--shadow); padding:28px; min-height:60vh}
    .header{display:flex; align-items:center; gap:14px; margin-bottom:6px}
    .header h1{margin:0; font-size:28px; font-weight:800; background:linear-gradient(135deg,var(--primary),var(--primary-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
    .sub{color:#64748b; margin:0 0 16px}

    .alert{display:none; border-radius:12px; padding:10px 12px; margin:10px 0; font-size:.9rem}
    .alert.show{display:block}
    .alert.error{background:#fee2e2; border:1px solid #fecaca; color:#7f1d1d}
    .alert.warn{background:#fef3c7; border:1px solid #fde68a; color:#78350f}
    .alert .close{float:right; cursor:pointer}

    .controls-wrap{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; margin-bottom:12px; }
    .search-box{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:var(--soft); border:1px solid var(--border); border-radius:14px; padding:10px 12px; }
    .search-input{ min-width:260px; flex:1; border:1px solid var(--border); outline:0; border-radius:10px; padding:9px 12px; font-size:.9rem; }
    .file-input{ position:relative }
    .file-input input{ position:absolute; inset:0; opacity:0; cursor:pointer }
    .file-btn{ display:inline-flex; align-items:center; gap:8px; border:0; background:linear-gradient(135deg,var(--primary),var(--primary-2));
        color:#fff; padding:9px 12px; border-radius:10px; font-weight:700; box-shadow:var(--shadow); cursor:pointer }
    .file-name{font-size:.85rem; color:#334155}

    .filters{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }

    .pill{ position:relative; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 12px; cursor:pointer;
        font-size:.85rem; line-height:1; user-select:none; min-width:160px; display:flex; align-items:center; gap:6px; }
    .pill strong{font-size:.85rem}
    .pill .value{color:#2563eb; font-weight:700}
    .pill .chev{margin-left:auto; color:#2563eb}
    .menu{ position:absolute; top:calc(100% + 6px); left:0; z-index:25; background:#fff; border:1px solid var(--border); border-radius:12px;
        box-shadow:0 14px 32px rgba(2,6,23,.15); min-width:260px; max-height:320px; overflow:auto; padding:8px; display:none; }
    .pill.open .menu{display:block}
    .menu .menu-search{ width:100%; border:1px solid var(--border); border-radius:8px; padding:7px 10px; font-size:.85rem; margin:2px 0 8px 0; }
    .opt{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:.9rem}
    .opt:hover{background:#f3f7ff} .opt input{accent-color:#2563eb}
    .menu-actions{display:flex; gap:8px; padding:8px 10px}
    .menu-actions button{border:1px solid var(--border); background:#f9fbff; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:.85rem}
    .menu-actions button.apply{background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; border:0}
    .clear-btn{ border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:12px; font-weight:800; font-size:.85rem; cursor:pointer }

    .section{background:#fff; border:1px solid var(--border); border-radius:18px; padding:18px; margin-top:12px}
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:14px}
    .kpi{background:#fff; border:1px solid var(--border); border-radius:16px; padding:16px; position:relative; overflow:hidden}
    .kpi::before{content:''; position:absolute; left:0; top:0; right:0; height:4px; background:linear-gradient(135deg,var(--primary),var(--primary-2))}
    .kpi .lab{font-size:.78rem; color:#64748b; text-transform:uppercase; font-weight:800; letter-spacing:.4px}
    .kpi .val{font-size:1.55rem; font-weight:800; color:var(--primary)}
    .kpi .val.neg{ color:var(--danger); }

    .charts{display:grid; grid-template-columns:repeat(2,1fr); gap:16px}
    .chart{height:360px}
    .chart.wide{grid-column:1 / -1}
    .chart.large{height:420px}

    .table{overflow:auto}
    table{width:100%; border-collapse:collapse; font-size:.9rem}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border)}
    th{position:sticky; top:0; background:#f5f9ff; text-align:left; user-select:none; white-space:nowrap}
    th.sortable{cursor:pointer}
    th .sort{margin-left:6px; color:#64748b}
    th.active{color:#1e293b}
    th.active .sort{color:#2563eb}
    tr:hover td{background:#fafcff}

    /* célula de placa clicável (excluir/reincluir) */
    td.cell-placa{ cursor:pointer; text-decoration:underline; }
    td.cell-placa:hover{ text-decoration:none; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fa-solid fa-chart-line"></i> Vendas</h1>
    </div>
    <p class="sub"></p>

    <div id="alertError" class="alert error"><span class="msg"></span><span class="close" onclick="this.parentElement.classList.remove('show')">✕</span></div>
    <div id="alertWarn" class="alert warn"><span class="msg"></span><span class="close" onclick="this.parentElement.classList.remove('show')">✕</span></div>

    <div class="controls-wrap">
        <div class="search-box">
            <input id="q" class="search-input" placeholder="Buscar modelo ou placa" />
            <div class="file-input">
                <button class="file-btn"><i class="fa-solid fa-file-excel"></i> Selecionar arquivo</button>
                <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
            </div>
            <span id="fileName" class="file-name"></span>
        </div>
        <button id="clearAll" class="clear-btn"><i class="fa-solid fa-eraser"></i> Limpar Filtros</button>
    </div>

    <div class="filters" id="filters"></div>

    <!-- KPIs -->
    <div class="section">
        <div id="kpis" class="kpis"></div>
    </div>

    <!-- GRÁFICOS -->
    <div class="section">
        <div class="charts">
            <div class="chart"><canvas id="lojaChart"></canvas></div>
            <div class="chart large"><canvas id="modeloChart"></canvas></div>
            <div class="chart"><canvas id="faixasEstoqueChart"></canvas></div>
            <div class="chart"><canvas id="vendedorRecebeuChart"></canvas></div>

            <!-- AGORA: dois gráficos lado a lado: Vendas TOP10 e Margem TOP10 -->
            <div class="chart"><canvas id="vendedorChart"></canvas></div>
            <div class="chart"><canvas id="vendedorMargemChart"></canvas></div>
        </div>
    </div>

    <!-- TABELA -->
    <div class="section table">
        <table id="grid">
            <thead>
                <tr>
                    <th class="sortable" data-key="Vendedor" data-type="text">Vendedor <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="Loja" data-type="text">Loja <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="Placa" data-type="text">Placa <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="ModeloBase" data-type="text">Modelo <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="Valor Venda" data-type="num">Valor de Venda <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="Nota de Entrada" data-type="num">Total Nota Fábrica <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="Custo Total Final" data-type="num">Custo Total <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="Margem" data-type="num">Margem (%) <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="Dias de Estoque" data-type="num">Dias de Estoque <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="KM" data-type="num">KM <i class="fa-solid fa-sort sort"></i></th>
                    <th class="sortable" data-key="Ano" data-type="num">Ano <i class="fa-solid fa-sort sort"></i></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ===== Helpers UI ===== */
function showError(msg){ const el=document.getElementById('alertError'); el.querySelector('.msg').textContent=msg; el.classList.add('show'); }
function showWarn(msg){ const el=document.getElementById('alertWarn'); el.querySelector('.msg').textContent=msg; el.classList.add('show'); }

/* ===== Util ===== */
const $ = s => document.querySelector(s);
const BRL = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(+v||0);
const NUM = v => new Intl.NumberFormat('pt-BR').format(+v||0);

/* ===== Scroll estável (contra “pulo para cima”) ===== */
function withStableScroll(fn){
    const x = window.pageXOffset || 0;
    const y = window.pageYOffset || 0;
    fn();
    requestAnimationFrame(()=>{ 
        window.scrollTo(x,y);
        requestAnimationFrame(()=>{ window.scrollTo(x,y); });
    });
}

/* ===== Conversões ===== */
function toNumberBR(x){
    if (x===null || x===undefined || x==='') return 0;
    if (typeof x==='number') return x;
    const s = String(x).trim();
    const clean = s.replace(/[R$\s]/g,'').replace(/\./g,'').replace(/,/g,'.');
    const n = parseFloat(clean);
    return isNaN(n)?0:n;
}
function parseDateExcel(v){
    if (typeof v==='number') {
        const base = new Date(Date.UTC(1899,11,30));
        return new Date(base.getTime()+v*86400000);
    }
    const d = new Date(v); return isNaN(+d)?null:d;
}
/* >>> extrai mês por padrão “/MM/” quando a célula é texto <<< */
function monthNameFromCell(cell){
    const nomes = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
    if(cell===null || cell===undefined || cell==='') return 'Não informado';

    if(typeof cell === 'string'){
        const m = cell.match(/\/(\d{2})\//);
        if(m){
            const mm = parseInt(m[1],10);
            if(mm>=1 && mm<=12){
                const nome = nomes[mm-1];
                return nome.charAt(0).toUpperCase()+nome.slice(1);
            }
        }
        const d = new Date(cell);
        if(!isNaN(+d)){
            const nome = d.toLocaleDateString('pt-BR',{month:'long'});
            return nome.charAt(0).toUpperCase()+nome.slice(1);
        }
        return 'Não informado';
    }

    if(typeof cell === 'number'){
        const d = parseDateExcel(cell);
        if(d){
            const nome = d.toLocaleDateString('pt-BR',{month:'long'});
            return nome.charAt(0).toUpperCase()+nome.slice(1);
        }
        return 'Não informado';
    }

    const d = new Date(cell);
    if(!isNaN(+d)){
        const nome = d.toLocaleDateString('pt-BR',{month:'long'});
        return nome.charAt(0).toUpperCase()+nome.slice(1);
    }
    return 'Não informado';
}

function modelBase(txt){
    if(!txt) return 'Não informado';
    const u = String(txt).toUpperCase();
    const cats = ['ARGO','CRONOS','MOBI','UNO','STRADA','TORO','FIORINO','DUCATO','HB20','HB20S','CRETA','GOL','POLO','VIRTUS','T-CROSS','GOLF','UP','PRISMA','ONIX','TRACKER','S10','ECOSPORT','KA','RANGER','CIVIC','CITY','FIT','COROLLA','HILUX','RAV4','PULSE','AGILE','AIRCROSS','ALL'];
    for(const c of cats){ if(u.includes(c)) return c; }
    return u.split(/\s+/).find(w=>w.length>2) || 'Outros';
}
function normalizeYear(val){
    if(val===null || val===undefined || val==='') return null;
    const s = String(val).trim();
    const m4 = s.match(/\b(19|20)\d{2}\b/g);
    if(m4 && m4.length) return parseInt(m4.map(Number).sort((a,b)=>b-a)[0],10);
    const m2pair = s.match(/\b(\d{2})\s*[/\-]\s*(\d{2})\b/);
    if(m2pair){
        const a = parseInt(m2pair[1],10), b = parseInt(m2pair[2],10);
        const two = Math.max(a,b);
        const now2 = new Date().getFullYear()%100;
        const century = two <= now2+1 ? 2000 : 1900;
        return century + two;
    }
    const n = toNumberBR(s);
    if(Number.isFinite(n)){
        if(n>=1900 && n<=2099) return Math.floor(n);
        if(n>=0 && n<100){
            const now2 = new Date().getFullYear()%100;
            const century = n <= now2+1 ? 2000 : 1900;
            return century + Math.floor(n);
        }
    }
    return null;
}
function normalizePlate(val){
    if(val===null || val===undefined) return 'Não informado';
    let s = String(val).toUpperCase().trim();
    if(!s) return 'Não informado';
    const raw = s.replace(/[^A-Z0-9]/g,'');
    if(raw.length===7){
        if(/\d{4}$/.test(raw)) return raw.slice(0,3)+'-'+raw.slice(3);
        return raw;
    }
    return s;
}
function findCol(headers, aliases){
    const lc = headers.map(h => String(h||'').toLowerCase().trim());
    for(const a of aliases){
        const idx = lc.indexOf(a.toLowerCase());
        if(idx>=0) return idx;
    }
    return -1;
}

/* ===== Estado ===== */
let allData = [];
let filtered = [];
let charts = { loja:null, modelo:null, vendedor:null, vendedorMargem:null, faixas:null, vendRecebeu:null };

/* set de placas excluídas */
const excludedPlates = new Set();

const state = { search:'', Loja:[], Vendedor:[], Modelo:[], Tipo:[], Mes:[], ValorFaixa:[], DptFaixa:[] };
const sortState = { key:null, type:null, dir:'desc' };

/* ===== Faixas ===== */
const VALOR_FAIXAS = [
  { label: 'R$ 0,01–70.000,00',      test: v => v>0 && v<=70000 },
  { label: 'R$ 70.000,01–90.000,00', test: v => v>70000 && v<=90000 },
  { label: 'R$ 90.000,01–110.000,00',test: v => v>90000 && v<=110000 },
  { label: 'R$ 110.000,01+',         test: v => v>110000 }
];
const DPT_FAIXAS = [
  { label: '0–30',    test: d => Number.isFinite(d) && d>=0   && d<=30  },
  { label: '31–60',   test: d => Number.isFinite(d) && d>=31  && d<=60  },
  { label: '61–90',   test: d => Number.isFinite(d) && d>=61  && d<=90  },
  { label: '91–120',  test: d => Number.isFinite(d) && d>=91  && d<=120 },
  { label: '121+',    test: d => Number.isFinite(d) && d>=121 }
];

/* ===== Pílulas ===== */
class MultiPill {
    constructor({label,getter,setter}){
        this.getter=getter; this.setter=setter;
        this.el=document.createElement('div');
        this.el.className='pill'; this.el.tabIndex=0;
        this.el.innerHTML=`<strong>${label}:</strong> <span class="value">Todos</span> <i class="fa-solid fa-chevron-down chev"></i><div class="menu"></div>`;
        this.menu=this.el.querySelector('.menu'); this.valueEl=this.el.querySelector('.value');
        this.searchInput = null;

        this.el.addEventListener('click',e=>{
            if(!e.target.closest('.menu')){
                const x = window.pageXOffset, y = window.pageYOffset;
                this.el.classList.toggle('open');
                if(this.searchInput) this.searchInput.focus();
                window.scrollTo(x,y);
            }
        });
        document.addEventListener('click',e=>{
            if(!this.el.contains(e.target)){
                const x = window.pageXOffset, y = window.pageYOffset;
                this.el.classList.remove('open');
                window.scrollTo(x,y);
            }
        });
    }
    setOptions(opts, {keepOrder=false}={}){
        const unique = [...new Set(opts.filter(Boolean))];
        this.options = keepOrder ? unique : unique.sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));
        this.render();
    }
    render(){
        const sel = new Set(this.getter());
        this.menu.innerHTML='';
        const s = document.createElement('input');
        s.placeholder='Pesquisar...'; s.className='menu-search'; this.menu.append(s); this.searchInput=s;
        const acts=document.createElement('div'); acts.className='menu-actions';
        const limpar=document.createElement('button'); limpar.textContent='Limpar';
        const aplicar=document.createElement('button'); aplicar.textContent='Aplicar'; aplicar.className='apply';
        acts.append(limpar,aplicar); this.menu.append(acts);
        const list=document.createElement('div'); list.className='list'; this.menu.append(list);

        for(const o of this.options){
            const row=document.createElement('label'); row.className='opt'; row.dataset.text = String(o).toLowerCase();
            const chk=document.createElement('input'); chk.type='checkbox'; chk.value=o; chk.checked=sel.has(o);
            row.append(chk, document.createElement('span')); row.lastChild.textContent=o;
            list.append(row);
        }

        s.oninput = ()=>{
            const q = s.value.toLowerCase();
            list.querySelectorAll('.opt').forEach(el=>{
                el.style.display = el.dataset.text.includes(q) ? '' : 'none';
            });
        };

        limpar.onclick=()=> withStableScroll(()=>{
            this.setter([]);
            this.sync();
            applyFilters();
        });
        aplicar.onclick=()=> withStableScroll(()=>{
            const vals=[...list.querySelectorAll('input:checked')].map(i=>i.value);
            this.setter(vals);
            this.el.classList.remove('open');
            this.sync();
            applyFilters();
        });

        list.addEventListener('click', (ev)=>{
            const input = ev.target.closest('input[type="checkbox"]');
            if(!input) return;
            const temp = new Set(this.getter());
            if(input.checked) temp.add(input.value); else temp.delete(input.value);
            const arr = [...temp];
            this.valueEl.textContent = !arr.length ? 'Todos' : (arr.length<=2 ? arr.join(', ') : `${arr[0]}, ${arr[1]} (+${arr.length-2})`);
        });

        this.sync();
    }
    sync(){
        const v=this.getter();
        this.valueEl.textContent = !v||v.length===0 ? 'Todos' : (v.length<=2 ? v.join(', ') : `${v[0]}, ${v[1]} (+${v.length-2})`);
    }
}
const pillInstances = {
    Mes:        new MultiPill({label:'Mês', getter:()=>state.Mes, setter:v=>state.Mes=v}),
    Loja:       new MultiPill({label:'Loja', getter:()=>state.Loja, setter:v=>state.Loja=v}),
    Vendedor:   new MultiPill({label:'Vendedor', getter:()=>state.Vendedor, setter:v=>state.Vendedor=v}),
    Modelo:     new MultiPill({label:'Modelo', getter:()=>state.Modelo, setter:v=>state.Modelo=v}),
    Tipo:       new MultiPill({label:'Tipo', getter:()=>state.Tipo, setter:v=>state.Tipo=v}),
    ValorFaixa: new MultiPill({label:'Valor de Venda', getter:()=>state.ValorFaixa, setter:v=>state.ValorFaixa=v}),
    DptFaixa:   new MultiPill({label:'Dias de Estoque', getter:()=>state.DptFaixa, setter:v=>state.DptFaixa=v}),
};
(function mountPills(){
    const holder = document.getElementById('filters');
    /* Ordem visual: Mês à esquerda de Loja */
    ['Mes','Loja','Vendedor','Modelo','Tipo','ValorFaixa','DptFaixa'].forEach(k=>{
        holder.appendChild(pillInstances[k].el);
    });
    pillInstances.ValorFaixa.setOptions(VALOR_FAIXAS.map(f=>f.label), {keepOrder:true});
    pillInstances.DptFaixa.setOptions(DPT_FAIXAS.map(f=>f.label), {keepOrder:true});
})();

/* ===== Upload ===== */
const fileInput = document.getElementById('fileInput');
const fileNameEl = document.getElementById('fileName');
fileInput.addEventListener('change', ev => { const f = ev.target.files?.[0]; if(f){ fileNameEl.textContent = f.name; readFile(f); } });

/* ===== Parser ===== */
async function readFile(file){
    try{
        if(!window.XLSX){ showError('Biblioteca XLSX não carregada. Verifique sua internet.'); return; }
        const ext = (file.name.split('.').pop()||'').toLowerCase();
        if(!['xlsx','xls','csv'].includes(ext)){
            showWarn('Formato não suportado. Use .xlsx, .xls ou .csv'); return;
        }
        if(ext==='csv'){
            const text = await file.text();
            const wb = XLSX.read(text, {type:'string'});
            processWorkbook(wb);
        }else{
            const buf = await file.arrayBuffer();
            const wb = XLSX.read(new Uint8Array(buf), {type:'array'});
            processWorkbook(wb);
        }
    }catch(err){
        console.error(err);
        showError('Falha ao ler o arquivo. Verifique se não está protegido e se possui ao menos uma planilha com dados.');
    }
}

/* ===== Processamento ===== */
function processWorkbook(wb){
    const name = wb.SheetNames.find(n=>{
        const ws = wb.Sheets[n];
        const range = XLSX.utils.decode_range(ws['!ref']||'A1:A1');
        return (range.e.r - range.s.r) >= 1;
    }) || wb.SheetNames[0];

    const ws = wb.Sheets[name];
    if(!ws){ showError('A planilha parece vazia.'); return; }

    const mat = XLSX.utils.sheet_to_json(ws,{header:1, blankrows:false});
    if(!mat || !mat.length){ showError('Não encontrei linhas com dados.'); return; }

    let headerIdx = detectHeaderRow(mat);
    const headers = (mat[headerIdx]||[]).map(x=>String(x||'').trim());
    const dataRows = mat.slice(headerIdx+1);

    if(headers.filter(x=>x).length<2){
        showWarn('Não consegui identificar o cabeçalho com clareza. Vou considerar a primeira linha com dados.');
    }

    parseRows(headers, dataRows);
}
function detectHeaderRow(mat){
    let best = 0, bestIdx = 0;
    const maxCheck = Math.min(10, mat.length);
    for(let i=0;i<maxCheck;i++){
        const row = mat[i]||[];
        const filled = row.filter(c=>c!==undefined && c!==null && String(c).trim()!=='').length;
        const hasText = row.some(c=> typeof c==='string' && c.trim().length>0 );
        if(hasText && filled > best){ best = filled; bestIdx = i; }
    }
    return bestIdx;
}

/* ===== Leitura das linhas ===== */
function parseRows(headers, data){
    const idx = {
        vendedor:  findCol(headers, ['Vendedor','VENDEDOR']),
        vendRecebe:findCol(headers, ['Vendedor que Recebeu','VENDEDOR QUE RECEBEU','Vendedor que recebeu','Vendedor Recebeu']),
        loja:      findCol(headers, ['Loja','LOJA','Pátio','Patio','PATIO']),
        placa:     findCol(headers, ['PLACA USADO','Placa Usado','PLACA_USADO','PLACA USADA','Placa Usada','PLACA','Placa','Placa do Veículo','PLACA VEICULO','PLACA DO VEICULO','Placa Veículo']),
        modelo:    findCol(headers, ['Descrição Modelo','Decrição Modelo','Modelo','MODELO','Descrição do Modelo']),
        valor:     findCol(headers, ['Valor Venda','VALOR VENDA','Valor de Venda']),
        custoTot:  findCol(headers, ['Custo Total Final','Custo Total','CUSTO TOTAL FINAL']),
        notaEnt:   findCol(headers, ['Total Nota Fabrica','Total Nota Fábrica','Nota de Entrada','NOTA DE ENTRADA','Nota Entrada','NF Entrada','Valor Entrada']),
        tipo:      findCol(headers, ['Tipo','TIPO','Tipo de venda']),
        km:        findCol(headers, ['KM','Km','Quilometragem','KM_USADO']),
        ano:       findCol(headers, ['Ano','ANO','Ano Modelo','Ano/Modelo','ANO MODELO']),
        diasEst:   findCol(headers, ['DPT','Dias de Estoque','DIAS DE ESTOQUE','DiasEstoque','Dias_Estoque','Dias em Estoque']),
        dataVend:  findCol(headers, ['Data Venda','DATA VENDA','Data de Venda','Data venda','Data','DATA']),
        ganhosInd: findCol(headers, ['Ganhos Indiretos','GANHOS INDIRETOS','Ganho Indireto','GANHO INDIRETO'])
    };

    if(idx.placa<0){ showWarn('Coluna de placa não encontrada. Procuro por "PLACA USADO", "PLACA", etc.'); }

    allData = data.map(r=>{
        const get = (i)=> i>=0 ? r[i] : undefined;

        const dptRaw = toNumberBR(get(idx.diasEst));
        const dptNorm = Number.isFinite(dptRaw) ? (dptRaw < 0 ? null : dptRaw) : null;

        // MÊS baseado na “Data venda”
        const dataVendaCell = get(idx.dataVend);
        const mesCap = monthNameFromCell(dataVendaCell);

        return {
            Vendedor: get(idx.vendedor) ?? 'Não informado',
            VendedorRecebeu: get(idx.vendRecebe) ?? 'Não informado',
            Loja:     get(idx.loja) ?? 'Não informado',
            Placa:    normalizePlate(get(idx.placa) ?? 'Não informado'),
            'Descrição Modelo': get(idx.modelo) ?? '',
            ModeloBase: modelBase(get(idx.modelo) ?? ''),
            'Valor Venda': toNumberBR(get(idx.valor)),
            'Custo Total Final': toNumberBR(get(idx.custoTot)),
            'Nota de Entrada': toNumberBR(get(idx.notaEnt)),
            Tipo: (()=>{
                const v = (get(idx.tipo) ?? '').toString().toLowerCase();
                if(v.includes('usad')) return 'Usados';
                if(v.includes('novo')) return 'Novos';
                if(v.includes('imobiliz')) return 'Imobilizado';
                return (get(idx.tipo) ?? 'Não informado') || 'Não informado';
            })(),
            KM: toNumberBR(get(idx.km)),
            Ano: normalizeYear(get(idx.ano)),
            'Dias de Estoque': dptNorm,
            MesNome: mesCap,
            'Ganhos Indiretos': toNumberBR(get(idx.ganhosInd))
        };
    });

    /* opções dos filtros dinâmicos */
    pillInstances.Loja.setOptions(allData.map(x=>x.Loja));
    pillInstances.Vendedor.setOptions(allData.map(x=>x.Vendedor));
    pillInstances.Modelo.setOptions(allData.map(x=>x.ModeloBase));
    pillInstances.Tipo.setOptions(allData.map(x=>x.Tipo));

    /* Mês: ordena Janeiro–Dezembro mas lista só os existentes */
    const orderMes = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
    const mesesUnicos = [...new Set(allData
        .map(x=>x.MesNome)
        .filter(m=>m && m!=='Não informado'))]
        .sort((a,b)=> orderMes.indexOf(a.toLowerCase()) - orderMes.indexOf(b.toLowerCase()));
    pillInstances.Mes.setOptions(mesesUnicos, {keepOrder:true});

    pillInstances.ValorFaixa.setOptions(VALOR_FAIXAS.map(f=>f.label), {keepOrder:true});
    pillInstances.DptFaixa.setOptions(DPT_FAIXAS.map(f=>f.label), {keepOrder:true});

    applyFilters();
}

/* ===== Busca e Limpar ===== */
document.getElementById('q').addEventListener('input', e=>{ state.search=e.target.value.toLowerCase(); withStableScroll(()=>applyFilters()); });
document.getElementById('clearAll').addEventListener('click', ()=>{
    withStableScroll(()=>{
        state.search=''; document.getElementById('q').value='';
        state.Loja=[]; state.Vendedor=[]; state.Modelo=[]; state.Tipo=[]; state.Mes=[]; state.ValorFaixa=[]; state.DptFaixa=[];
        Object.values(pillInstances).forEach(p=>{ p.setter([]); p.render(); p.sync(); });
        pillInstances.ValorFaixa.setOptions(VALOR_FAIXAS.map(f=>f.label), {keepOrder:true});
        pillInstances.DptFaixa.setOptions(DPT_FAIXAS.map(f=>f.label), {keepOrder:true});
        const orderMes = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
        const mesesUnicos = [...new Set(allData
            .map(x=>x.MesNome)
            .filter(m=>m && m!=='Não informado'))]
            .sort((a,b)=> orderMes.indexOf(a.toLowerCase()) - orderMes.indexOf(b.toLowerCase()));
        pillInstances.Mes.setOptions(mesesUnicos, {keepOrder:true});
        excludedPlates.clear();
        applyFilters();
    });
});

/* ===== Filtragem + Ordenação ===== */
function applyFilters(){
    filtered = allData.filter(r=>{
        const lojaOk = state.Loja.length===0 || state.Loja.includes(r.Loja);
        const vendOk = state.Vendedor.length===0 || state.Vendedor.includes(r.Vendedor);
        const modOk  = state.Modelo.length===0 || state.Modelo.includes(r.ModeloBase);
        const tipoOk = state.Tipo.length===0 || state.Tipo.includes(r.Tipo);
        const mesOk  = state.Mes.length===0 || state.Mes.includes(r.MesNome);

        const v = +r['Valor Venda']||0;
        const valorOk = state.ValorFaixa.length===0 || state.ValorFaixa.some(lbl => {
            const fx = VALOR_FAIXAS.find(f=>f.label===lbl);
            return fx ? fx.test(v) : true;
        });

        const d = r['Dias de Estoque'];
        const dptOk = state.DptFaixa.length===0 || state.DptFaixa.some(lbl => {
            const fx = DPT_FAIXAS.find(f=>f.label===lbl);
            return fx ? fx.test(d) : true;
        });

        const q = state.search;
        const qOk = !q || [ r['Descrição Modelo'], r.Placa, r.ModeloBase ].some(vv=> (vv||'').toString().toLowerCase().includes(q));

        const notExcluded = !excludedPlates.has(r.Placa);

        return lojaOk && vendOk && modOk && tipoOk && mesOk && valorOk && dptOk && qOk && notExcluded;
    });
    renderKPIs();
    renderTable(sortRows([...filtered]));
    renderCharts(filtered);
}

/* ===== KPIs ===== */
function calcKPIs(rows){
    const n = rows.length;
    const valorTotal = rows.reduce((s,r)=>s+(+r['Valor Venda']||0),0);
    const notaEntradaTotal = rows.reduce((s,r)=>s+(+r['Nota de Entrada']||0),0);
    const custoTotal = rows.reduce((s,r)=>s+(+r['Custo Total Final']||0),0);
    const ganhosIndiretosTotal = rows.reduce((s,r)=>s+(+r['Ganhos Indiretos']||0),0);

    const ticketMedio = n? valorTotal/n : 0;

    const lucroBruto = valorTotal - notaEntradaTotal;
    const lucroLiquido = valorTotal - custoTotal;

    const lucroBrutoMedio = n ? lucroBruto/n : 0;
    const lucroLiquidoMedio = n ? lucroLiquido/n : 0;

    const margemBrutaPercent = valorTotal>0 ? (lucroBruto/valorTotal)*100 : 0;
    const margemLiquidaPercent = valorTotal>0 ? (lucroLiquido/valorTotal)*100 : 0;

    const anos = rows.map(r=>r.Ano).filter(v=>Number.isFinite(v));
    const anoMedio = anos.length? (anos.reduce((a,b)=>a+b,0)/anos.length) : 0;

    const dias = rows.map(r=>r['Dias de Estoque']).filter(v=>Number.isFinite(v));
    const mediaDiasEstoque = dias.length? dias.reduce((a,b)=>a+b,0)/dias.length : 0;

    const kms = rows.map(r=>r.KM).filter(v=>Number.isFinite(v) && v>0);
    const kmMedio = kms.length? kms.reduce((a,b)=>a+b,0)/kms.length : 0;

    return {
        n, valorTotal, notaEntradaTotal, custoTotal, ticketMedio,
        lucroBruto, lucroBrutoMedio, lucroLiquido, lucroLiquidoMedio,
        margemBrutaPercent, margemLiquidaPercent,
        anoMedio, mediaDiasEstoque, kmMedio, ganhosIndiretosTotal
    };
}
function renderKPIs(){
    const k = calcKPIs(filtered);
    const lucroBrutoClass        = k.lucroBruto < 0 ? 'val neg' : 'val';
    const lucroBrutoMedioClass   = k.lucroBrutoMedio < 0 ? 'val neg' : 'val';
    const lucroLiquidoClass      = k.lucroLiquido < 0 ? 'val neg' : 'val';
    const lucroLiquidoMedioClass = k.lucroLiquidoMedio < 0 ? 'val neg' : 'val';
    const margemBrutaClass       = k.margemBrutaPercent < 0 ? 'val neg' : 'val';
    const margemLiquidaClass     = k.margemLiquidaPercent < 0 ? 'val neg' : 'val';

    const html = `
        <div class="kpi"><div class="lab">Total de Vendas</div><div class="val">${NUM(k.n)}</div></div>
        <div class="kpi"><div class="lab">Valor Total Vendido</div><div class="val">${BRL(k.valorTotal)}</div></div>
        <div class="kpi"><div class="lab">Total Nota Fábrica</div><div class="val">${BRL(k.notaEntradaTotal)}</div></div>
        <div class="kpi"><div class="lab">Ticket Médio</div><div class="val">${BRL(k.ticketMedio)}</div></div>

        <div class="kpi"><div class="lab">Lucro Bruto Total</div><div class="${lucroBrutoClass}">${BRL(k.lucroBruto)}</div></div>
        <div class="kpi"><div class="lab">Lucro Bruto Médio</div><div class="${lucroBrutoMedioClass}">${BRL(k.lucroBrutoMedio)}</div></div>
        <div class="kpi"><div class="lab">Lucro Líquido</div><div class="${lucroLiquidoClass}">${BRL(k.lucroLiquido)}</div></div>
        <div class="kpi"><div class="lab">Lucro Líquido Médio</div><div class="${lucroLiquidoMedioClass}">${BRL(k.lucroLiquidoMedio)}</div></div>

        <div class="kpi"><div class="lab">Lucro Bruto %</div><div class="${margemBrutaClass}">${k.margemBrutaPercent.toFixed(2)}%</div></div>
        <div class="kpi"><div class="lab">Lucro Líquido NBS %</div><div class="${margemLiquidaClass}">${k.margemLiquidaPercent.toFixed(2)}%</div></div>
        <div class="kpi"><div class="lab">Ano Médio</div><div class="val">${k.anoMedio? Math.round(k.anoMedio): '—'}</div></div>
        <div class="kpi"><div class="lab">Média Dias de Estoque</div><div class="val">${Number.isFinite(k.mediaDiasEstoque)? k.mediaDiasEstoque.toFixed(1): '0'}</div></div>
        <div class="kpi"><div class="lab">KM Médio</div><div class="val">${k.kmMedio? NUM(Math.round(k.kmMedio)) : '—'}</div></div>
        <div class="kpi"><div class="lab">Ganhos Indiretos</div><div class="val">${BRL(k.ganhosIndiretosTotal)}</div></div>
    `;
    document.getElementById('kpis').innerHTML = html;
}

/* ===== Ordenação/Tabela ===== */
function rowMargin(r){
    const valor = +r['Valor Venda']||0;
    const custo = +r['Custo Total Final']||0;
    return valor>0 ? ((valor - (custo||0))/valor)*100 : 0;
}
const collator = new Intl.Collator('pt-BR', {numeric:true, sensitivity:'base'});
function sortRows(rows){
    if(!sortState.key) return rows;
    const key = sortState.key, type = sortState.type, dir = sortState.dir==='asc'?1:-1;
    return rows.sort((a,b)=>{
        let va, vb;
        if(key==='Margem'){ va=rowMargin(a); vb=rowMargin(b); }
        else { va=a[key]; vb=b[key]; }
        if(type==='num'){
            va = Number(va)||0; vb = Number(vb)||0;
            return dir*(va-vb);
        }else{
            return dir*collator.compare(String(va||''), String(vb||''));
        }
    });
}
function renderTable(rows){
    const tb = document.querySelector('#grid tbody'); tb.innerHTML='';
    for(const r of rows){
        const valor = +r['Valor Venda']||0;
        const custo = +r['Custo Total Final']||0;
        const margem = rowMargin(r);
        const anoStr = Number.isFinite(r.Ano) ? String(r.Ano).padStart(4,'0') : '—';
        const dpt = r['Dias de Estoque'];
        const dptStr = Number.isFinite(dpt) ? NUM(dpt) : 'N/A';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="cell-vendedor" style="cursor:pointer; text-decoration:underline;">${r.Vendedor||'—'}</td>
            <td>${r.Loja||'—'}</td>
            <td class="cell-placa" title="Clique para desconsiderar/reconsiderar este carro">${r.Placa||'—'}</td>
            <td>${r.ModeloBase||'—'}</td>
            <td>${BRL(valor)}</td>
            <td>${BRL(r['Nota de Entrada']||0)}</td>
            <td>${BRL(custo)}</td>
            <td>${isFinite(margem)? margem.toFixed(2)+'%':'—'}</td>
            <td>${dptStr}</td>
            <td>${r.KM? NUM(r.KM): '—'}</td>
            <td>${anoStr}</td>
        `;
        tb.appendChild(tr);
    }
}
function initSorting(){
    const ths = document.querySelectorAll('#grid thead th.sortable');
    ths.forEach(th=>{
        th.addEventListener('click', ()=> withStableScroll(()=>{
            const key = th.dataset.key, type = th.dataset.type;
            if(sortState.key===key){
                sortState.dir = sortState.dir==='asc' ? 'desc':'asc';
            }else{
                sortState.key = key; sortState.type = type; sortState.dir = 'desc';
            }
            ths.forEach(t=>{ t.classList.remove('active'); t.querySelector('.sort').className='fa-solid fa-sort sort'; });
            th.classList.add('active');
            const icon = th.querySelector('.sort');
            icon.className = 'fa-solid ' + (sortState.dir==='asc' ? 'fa-sort-up':'fa-sort-down') + ' sort';
            renderTable(sortRows([...filtered]));
        }));
    });
}
initSorting();

/* seleção múltipla pelo nome do vendedor (tabela) e exclusão por placa */
function toggleVendorSelection(name){
    if(!name || name==='—' || name==='Não informado') return;
    const set = new Set(state.Vendedor);
    if(set.has(name)) set.delete(name); else set.add(name);
    state.Vendedor = [...set];
    pillInstances.Vendedor.sync();
    withStableScroll(()=> applyFilters());
}
document.querySelector('#grid tbody').addEventListener('click', (e)=>{
    const cell = e.target.closest('td');
    if(!cell) return;

    if(cell.classList.contains('cell-vendedor')){
        const name = (cell.textContent || '').trim();
        toggleVendorSelection(name);
        return;
    }

    if(cell.classList.contains('cell-placa')){
        const placa = (cell.textContent || '').trim();
        withStableScroll(()=>{
            if(excludedPlates.has(placa)) excludedPlates.delete(placa);
            else excludedPlates.add(placa);
            applyFilters();
        });
        return;
    }
});

/* tooltips */
function pctTooltip() {
    return {
        callbacks: {
            label: function(ctx){
                const val = Number(ctx.raw) || 0;
                const data = ctx.dataset.data || [];
                const total = data.reduce((a,b)=>a+(Number(b)||0), 0) || 1;
                const pct = ((val/total)*100).toFixed(1).replace('.',',');
                return `${val} / ${pct}%`;
            }
        }
    };
}
/* tooltip para margem média (mostra % e nº de vendas do vendedor) */
function margemTooltip(vendasPorVendedor){
    return {
        callbacks:{
            label: function(ctx){
                const i = ctx.dataIndex;
                const label = ctx.chart.data.labels[i];
                const avg = Number(ctx.raw) || 0;
                const qtd = vendasPorVendedor[label] || 0;
                return `${avg.toFixed(2).replace('.',',')}% (${qtd} vendas)`;
            }
        }
    };
}

/* gráficos */
function renderCharts(rows){
    const commonOpts = { responsive:true, maintainAspectRatio:false, animation:false };

    /* por loja */
    const porLoja={}; rows.forEach(r=>{ const k=r.Loja||'Não informado'; porLoja[k]=(porLoja[k]||0)+1; });
    const lojaArr = Object.entries(porLoja).sort((a,b)=>b[1]-a[1]);
    const l1 = lojaArr.map(x=>x[0]);
    const d1 = lojaArr.map(x=>x[1]);
    if(charts.loja) charts.loja.destroy();
    charts.loja=new Chart(document.getElementById('lojaChart').getContext('2d'),{
        type:'bar',
        data:{labels:l1,datasets:[{label:'Vendas',data:d1,borderWidth:2,borderRadius:8}]},
        options:{ ...commonOpts, plugins:{ legend:{display:false}, tooltip: pctTooltip(), title:{display:true, text:'Vendas por Loja'} } }
    });

    /* top modelos */
    const porMod={}; rows.forEach(r=>{ const k=r.ModeloBase||'Não informado'; porMod[k]=(porMod[k]||0)+1; });
    const top = Object.entries(porMod).sort((a,b)=>b[1]-a[1]).slice(0,5);
    if(charts.modelo) charts.modelo.destroy();
    charts.modelo=new Chart(document.getElementById('modeloChart').getContext('2d'),{
        type:'doughnut',
        data:{labels:top.map(x=>x[0]), datasets:[{data:top.map(x=>x[1])}]},
        options:{ ...commonOpts, cutout:'55%', plugins:{ tooltip: pctTooltip(), title:{display:true, text:'Top 5 Modelos Mais Vendidos'} } }
    });

    /* faixas de estoque (semáforo) */
    const faixas = { '1–30':0, '31–60':0, '61–90':0, '91–120':0, '121+':0 };
    rows.forEach(r=>{
        const d = r['Dias de Estoque'];
        if(!Number.isFinite(d) || d<=0) return;
        if(d<=30)       faixas['1–30']++;
        else if(d<=60)  faixas['31–60']++;
        else if(d<=90)  faixas['61–90']++;
        else if(d<=120) faixas['91–120']++;
        else            faixas['121+']++;
    });
    const bgSemaforo = ['#16a34a','#84cc16','#f59e0b','#f97316','#dc2626'];
    const bdSemaforo = ['#15803d','#65a30d','#d97706','#ea580c','#b91c1c'];
    if(charts.faixas) charts.faixas.destroy();
    charts.faixas=new Chart(document.getElementById('faixasEstoqueChart').getContext('2d'),{
        type:'bar',
        data:{ 
            labels:Object.keys(faixas), 
            datasets:[{
                label:'Qtde de veículos', 
                data:Object.values(faixas), 
                borderWidth:2, 
                borderRadius:8,
                backgroundColor:bgSemaforo,
                borderColor:bdSemaforo
            }]
        },
        options:{ 
            ...commonOpts,
            plugins:{ legend:{display:false}, tooltip: pctTooltip(), title:{display:true, text:'Distribuição por Faixas de Dias de Estoque '} }
        }
    });

    /* Vendas por Vendedor — TOP 10 */
    const vendasVendMap={}; rows.forEach(r=>{ const k=r.Vendedor||'Não informado'; vendasVendMap[k]=(vendasVendMap[k]||0)+1; });
    const vendArrTop10 = Object.entries(vendasVendMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const l3 = vendArrTop10.map(x=>x[0]);
    const d3 = vendArrTop10.map(x=>x[1]);
    if(charts.vendedor) charts.vendedor.destroy();
    charts.vendedor=new Chart(document.getElementById('vendedorChart').getContext('2d'),{
        type:'bar',
        data:{labels:l3,datasets:[{label:'Vendas',data:d3,borderWidth:2,borderRadius:8}]},
        options:{ 
            ...commonOpts,
            plugins:{ legend:{display:false}, tooltip: pctTooltip(), title:{display:true, text:'TOP 10 Vendedores — Vendas'} },
            onClick: (evt) => {
                const points = charts.vendedor.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
                if(!points || !points.length) return;
                const idx = points[0].index;
                const vendedor = charts.vendedor.data.labels[idx];
                withStableScroll(()=> {
                    const set = new Set(state.Vendedor);
                    if(set.has(vendedor)) set.delete(vendedor); else set.add(vendedor);
                    state.Vendedor = [...set];
                    pillInstances.Vendedor.sync();
                    applyFilters();
                });
            }
        }
    });

    /* Margem média por vendedor — TOP 10 */
    const margemAgg = {};
    rows.forEach(r=>{
        const vend = r.Vendedor || 'Não informado';
        const m = rowMargin(r);
        if(!Number.isFinite(m)) return;
        if(!margemAgg[vend]) margemAgg[vend] = {sum:0, n:0};
        margemAgg[vend].sum += m;
        margemAgg[vend].n += 1;
    });
    const avgArr = Object.entries(margemAgg)
        .map(([vend, obj])=> [vend, obj.n ? (obj.sum/obj.n) : 0, obj.n])
        .filter(([,avg,n])=> n>0)
        .sort((a,b)=> b[1]-a[1])
        .slice(0,10);
    const lM = avgArr.map(x=>x[0]);
    const dM = avgArr.map(x=> Number(x[1].toFixed(2)));
    // mapa auxiliar vendedor->qtd vendas para tooltip
    const mapQtd = Object.fromEntries(avgArr.map(([v, , n])=>[v,n]));

    if(charts.vendedorMargem) charts.vendedorMargem.destroy();
    charts.vendedorMargem=new Chart(document.getElementById('vendedorMargemChart').getContext('2d'),{
        type:'bar',
        data:{labels:lM, datasets:[{label:'Margem média (%)', data:dM, borderWidth:2, borderRadius:8}]},
        options:{
            ...commonOpts,
            plugins:{ 
                legend:{display:false}, 
                tooltip: margemTooltip(mapQtd),
                title:{display:true, text:'TOP 10 Vendedores — Margem média (%)'}
            },
            scales:{
                y:{ ticks:{ callback:(v)=> v + '%' } }
            },
            onClick: (evt) => {
                const points = charts.vendedorMargem.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
                if(!points || !points.length) return;
                const idx = points[0].index;
                const vendedor = charts.vendedorMargem.data.labels[idx];
                withStableScroll(()=> {
                    const set = new Set(state.Vendedor);
                    if(set.has(vendedor)) set.delete(vendedor); else set.add(vendedor);
                    state.Vendedor = [...set];
                    pillInstances.Vendedor.sync();
                    applyFilters();
                });
            }
        }
    });

    /* Vendedores que receberam carros (troca) — TOP 10 */
    const porReceb={};
    rows.forEach(r=>{
        const k = (r.VendedorRecebeu && String(r.VendedorRecebeu).trim()) ? r.VendedorRecebeu : 'Não informado';
        porReceb[k]=(porReceb[k]||0)+1;
    });
    const recebArr = Object.entries(porReceb)
        .filter(([k])=>k!=='Não informado')
        .sort((a,b)=>b[1]-a[1]).slice(0,10);
    const l4 = recebArr.map(x=>x[0]);
    const d4 = recebArr.map(x=>x[1]);
    if(charts.vendRecebeu) charts.vendRecebeu.destroy();
    charts.vendRecebeu = new Chart(document.getElementById('vendedorRecebeuChart').getContext('2d'), {
        type:'bar',
        data:{ labels:l4, datasets:[{ label:'Qtde de trocas recebidas', data:d4, borderWidth:2, borderRadius:8 }]},
        options:{ ...commonOpts, plugins:{ legend:{display:false}, tooltip: pctTooltip(), title:{display:true, text:'Top 10 Vendedores que mais receberam carros (troca)'} } }
    });
}
</script>
</body>
</html>